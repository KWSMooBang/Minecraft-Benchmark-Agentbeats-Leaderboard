#!/bin/bash
set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== MCU Benchmark Scenario Runner ===${NC}"

# Step 1: Check dependencies
echo -e "\n${YELLOW}[Step 1/14]${NC} Checking dependencies..."
command -v python3 >/dev/null 2>&1 || { echo -e "${RED}Error: python3 is required but not installed.${NC}" >&2; exit 1; }
command -v docker >/dev/null 2>&1 || { echo -e "${RED}Error: docker is required but not installed.${NC}" >&2; exit 1; }
command -v git >/dev/null 2>&1 || { echo -e "${RED}Error: git is required but not installed.${NC}" >&2; exit 1; }
command -v jq >/dev/null 2>&1 || { echo -e "${RED}Error: jq is required but not installed.${NC}" >&2; exit 1; }

# Step 2: Install Python dependencies
echo -e "\n${YELLOW}[Step 2/14]${NC} Installing Python dependencies..."
pip install -q tomli tomli-w pyyaml requests

# Step 3: Generate docker-compose.yml
echo -e "\n${YELLOW}[Step 3/14]${NC} Generating docker-compose.yml..."
python3 generate_compose.py --scenario scenario.toml

# Step 4: Pull Docker images
echo -e "\n${YELLOW}[Step 4/14]${NC} Pulling Docker images..."
if ! docker compose pull; then
    echo -e "${RED}"
    echo "Error: Failed to pull one or more images."
    echo "Ensure all images are publicly accessible."
    echo "For ghcr.io images, check package settings."
    echo -e "${NC}"
    exit 1
fi

# Step 5: Create output directory
echo -e "\n${YELLOW}[Step 5/14]${NC} Creating output directory..."
mkdir -p output && chmod 777 output

# Step 6: Export secrets as environment variables (if .env file exists)
echo -e "\n${YELLOW}[Step 6/14]${NC} Setting up environment variables..."
if [ -f .env ]; then
    echo "Using existing .env file"
else
    echo "Warning: .env file not found. Create one with your secrets if needed."
    touch .env
fi

# Step 7: Login to GitHub Container Registry (optional)
echo -e "\n${YELLOW}[Step 7/14]${NC} Checking GHCR authentication..."
if [ -n "$GHCR_TOKEN" ]; then
    echo "Logging in to GitHub Container Registry..."
    echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GITHUB_USER" --password-stdin
else
    echo "GHCR_TOKEN not set, skipping registry login"
fi

# Step 8: Run assessment
echo -e "\n${YELLOW}[Step 8/14]${NC} Running assessment with docker compose..."
docker compose up --timestamps --exit-code-from agentbeats-client --abort-on-container-exit

# Step 9: Record provenance
echo -e "\n${YELLOW}[Step 9/14]${NC} Recording provenance..."
python3 record_provenance.py --compose docker-compose.yml --output output/provenance.json

# Step 10: Generate submission metadata
echo -e "\n${YELLOW}[Step 10/14]${NC} Generating submission metadata..."
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
USERNAME=$(git config user.name | tr -d ' ' | tr '[:upper:]' '[:lower:]')
if [ -z "$USERNAME" ]; then
    USERNAME=$(whoami)
fi
UNIQUE_NAME="${USERNAME}-${TIMESTAMP}"
BRANCH_NAME="submission-${UNIQUE_NAME}"

echo "Unique name: $UNIQUE_NAME"
echo "Branch name: $BRANCH_NAME"

# Step 11: Copy files to submission directory
echo -e "\n${YELLOW}[Step 11/14]${NC} Copying files to submission directory..."
mkdir -p submissions results
cp scenario.toml "submissions/${UNIQUE_NAME}.toml"
cp output/results.json "results/${UNIQUE_NAME}.json"
cp output/provenance.json "submissions/${UNIQUE_NAME}.provenance.json"

# Step 12: Determine target repository
echo -e "\n${YELLOW}[Step 12/14]${NC} Determining target repository..."
CURRENT_REPO=$(git remote get-url origin | sed 's/.*github.com[:/]\(.*\)\.git/\1/')
if [ -z "$GH_TOKEN" ]; then
    echo "Warning: GH_TOKEN not set. Assuming current repo is the target."
    TARGET_REPO="$CURRENT_REPO"
else
    # Try to get parent repo using GitHub API
    PARENT_REPO=$(curl -s -H "Authorization: token $GH_TOKEN" \
        "https://api.github.com/repos/$CURRENT_REPO" | \
        jq -r '.parent.full_name // empty')
    
    if [ -n "$PARENT_REPO" ]; then
        TARGET_REPO="$PARENT_REPO"
    else
        TARGET_REPO="$CURRENT_REPO"
    fi
fi
echo "Target repository: $TARGET_REPO"

# Step 13: Create submission branch
echo -e "\n${YELLOW}[Step 13/14]${NC} Creating submission branch..."
git remote add upstream "https://github.com/${TARGET_REPO}.git" 2>/dev/null || true
git fetch upstream
git checkout -b "$BRANCH_NAME" upstream/main

# Step 14: Commit and push results
echo -e "\n${YELLOW}[Step 14/14]${NC} Committing and pushing results..."
git config user.name "$(git config user.name || echo 'Benchmark Runner')"
git config user.email "$(git config user.email || echo 'benchmark@example.com')"
git add "submissions/${UNIQUE_NAME}.toml" \
        "submissions/${UNIQUE_NAME}.provenance.json" \
        "results/${UNIQUE_NAME}.json"
git commit -m "Submission: ${UNIQUE_NAME}

Generated by local run script"

echo -e "\n${GREEN}Ready to push!${NC}"
echo "Run the following command to push:"
echo -e "  ${YELLOW}git push origin ${BRANCH_NAME}${NC}"
echo ""
echo "Then create a PR at:"
echo "  https://github.com/${TARGET_REPO}/compare/main...${CURRENT_REPO}:${BRANCH_NAME}?expand=1"
echo ""
echo -e "${RED}⚠️  When creating the PR, UNCHECK 'Allow edits and access to secrets by maintainers'${NC}"

# Cleanup
echo -e "\n${GREEN}Cleaning up...${NC}"
docker compose down -v || true

echo -e "\n${GREEN}=== Script completed successfully ===${NC}"
